<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHT Sensor</title>
    <!-- Include Bootstrap CSS (You can customize the link based on your setup) -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Include Socket.IO from CDN -->
    <!-- Include Firebase JavaScript SDK (Legacy) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #333;
        }
        
        li {
            float: left;
        }
        
        li a {
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }
        
        li a:hover:not(.active) {
            background-color: #111;
        }
        
        .active {
            background-color: #04AA6D;
        }
        
        #chart-container {
            max-width: 800px;
            margin: 0 auto;
        }
        /* Style individual charts */
        
        .chart {
            width: 100%;
            /* Use 100% width for responsiveness */
            max-width: 600px;
            /* Set a maximum width for each chart */
            margin: 20px 0 20px 20px;
            /* Add some margin between charts */
        }
        
        table {
            width: 80%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        
        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #04AA6D;
            color: white;
        }
    </style>
</head>

<body>
    <nav>
        <ul>
            <li><a class="active" href="/">Home</a></li>
            <li><a href="/input_fields">Temperature</a></li>
            <li><a href="/sensors">Sensors</a></li>
            <li><a href="#yourSensors">Your Sensors</a></li>
            {% if person.is_logged_in %}
            <li style="float:right;"><a href="{{ url_for('logout') }}">Logout, {{ person.name }}</a></li>
            {% endif %}
        </ul>
    </nav>
    <h1>DHT Sensor Information</h1>
    <div id="chart-container">
        <div class="chart">
            <canvas id="realtimeChart" width="400" height="200"></canvas>
        </div>
    </div>
    <h2>Real-time Data Table</h2>
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Temperature</th>
                <th>Humidity</th>
            </tr>
        </thead>
        <tbody id="dataTableBody">
            <!-- Data will be dynamically added here -->
        </tbody>
    </table>

    <script>
        // Initialize an empty chart
        var firebaseConfig = {
            "apiKey": "AIzaSyAtZb6-LRZMpCpPasCbk_vycTcRQ5fl7KA",
            "authDomain": "dpps-23928.firebaseapp.com",
            "databaseURL": "https://dpps-23928-default-rtdb.asia-southeast1.firebasedatabase.app",
            "projectId": "dpps-23928",
            "storageBucket": "dpps-23928.appspot.com",
            "messagingSenderId": "114905554074",
            "appId": "1:114905554074:web:d527757221e8fabe115323",
            "measurementId": "G-ES3ZDPZC4F",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Reference to the Firebase database
        var database = firebase.database();
        var ctx = document.getElementById('realtimeChart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperature Data',
                    data: [],
                    borderColor: 'blue',
                    borderWidth: 1,
                    fill: false,
                    tension: 0
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom'
                    }
                }
            }
        });

        // Update the chart only when new data is retrieved
        function updateChart() {
            // Fetch real-time data from the Flask route
            fetch('/realtime_data')
                .then(response => response.json())
                .then(data => {
                    // Check if the data is valid before updating the chart
                    if (isValidData(data)) {
                        // Update the chart with new data
                        updateChartData(data);
                    }
                });
        }

        function isValidData(data) {
            // Add your validation logic here
            // For example, check if data.timestamp and data.value exist and are of the correct type
            return data && typeof data.timestamp === 'number' && typeof data.value === 'number';
        }

        function updateChartData(data) {
            // Add new data to the chart
            chart.data.labels.push(data.timestamp);
            chart.data.datasets[0].data.push(data.value);

            // Set line color based on temperature ranges
            // Remove old data if the number of data points exceeds a certain limit
            if (chart.data.labels.length > 10) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }

            // Update the chart
            chart.update();
        }

        function updateDataTable() {
            // Fetch real-time data from the Firebase database
            database.ref('/realtime_data').once('value').then(function(snapshot) {
                var data = snapshot.val();
                if (data) {
                    // Update the table with new data
                    updateTableData(data);
                }
            });
        }

        function updateTableData(data) {
            // Get the table body element
            var tableBody = document.getElementById('dataTableBody');

            // Clear existing table rows
            tableBody.innerHTML = "";

            // Loop through the data and create table rows
            for (var key in data) {
                if (data.hasOwnProperty(key)) {
                    var rowData = data[key];
                    var row = document.createElement('tr');

                    // Create table cells and set data
                    var timestampCell = document.createElement('td');
                    timestampCell.textContent = rowData.Temperature.timestamp;

                    var temperatureCell = document.createElement('td');
                    temperatureCell.textContent = rowData.Temperature.value;

                    var humidityCell = document.createElement('td');
                    humidityCell.textContent = rowData.Humidity;

                    // Append cells to the row
                    row.appendChild(timestampCell);
                    row.appendChild(temperatureCell);
                    row.appendChild(humidityCell);

                    // Append row to the table body
                    tableBody.appendChild(row);
                }
            }
        }

        // Update the chart every 3 seconds
        setInterval(function() {
            updateChart();
            updateDataTable();
        }, 3000);
    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
</body>

</html>